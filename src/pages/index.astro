---
import Layout from '../layouts/Layout.astro';
import { db, posts } from '../lib/db';
import { desc } from 'drizzle-orm';
import Card from '@/components/starwind/card/Card.astro';
import CardHeader from '@/components/starwind/card/CardHeader.astro';
import CardTitle from '@/components/starwind/card/CardTitle.astro';
import CardContent from '@/components/starwind/card/CardContent.astro';
import CardFooter from '@/components/starwind/card/CardFooter.astro';
import Badge from '@/components/starwind/badge/Badge.astro';
import Button from '@/components/starwind/button/Button.astro';

// Query posts at build time, ordered by publishedAt descending
const allPosts = await db
  .select({
    id: posts.id,
    title: posts.title,
    company: posts.company,
    url: posts.url,
    publishedAt: posts.publishedAt,
    firecrawlData: posts.firecrawlData,
  })
  .from(posts)
  .orderBy(desc(posts.publishedAt));

// Helper to format date in Korean locale
const formatDate = (timestamp: Date) => {
  return new Intl.DateTimeFormat('ko-KR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(timestamp);
};

// Map companies to Badge variants
const companyBadgeVariants: Record<string, 'primary' | 'success' | 'warning' | 'info'> = {
  toss: 'primary',
  coupang: 'success',
  daangn: 'warning',
  kakao: 'warning',
  naver: 'success',
  line: 'info',
  woowahan: 'info',
};
---

<Layout>
  <div class="min-h-screen bg-gradient-to-b from-gray-50 to-white py-12">
    <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <header class="mb-12 text-center">
        <h1 class="text-5xl font-bold tracking-tight text-gray-900 sm:text-6xl">
          Tech Blog Posts
        </h1>
        <p class="mt-4 text-lg text-gray-600">
          Latest posts from Korean tech companies
        </p>
      </header>

      <!-- Feed -->
      <main class="space-y-6">
        {allPosts.map((post) => (
          <Card class="transition-all duration-200 hover:shadow-lg">
            <CardHeader>
              <div class="flex items-center gap-3">
                <Badge
                  variant={companyBadgeVariants[post.company] || 'default'}
                  class="uppercase"
                >
                  {post.company}
                </Badge>
                <time class="text-sm text-gray-500" datetime={post.publishedAt.toISOString()}>
                  {formatDate(post.publishedAt)}
                </time>
              </div>
            </CardHeader>

            <CardContent>
              <CardTitle class="mb-3">
                <a
                  href={post.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="hover:text-blue-600 transition-colors duration-150"
                >
                  {post.title}
                </a>
              </CardTitle>
              <p class="text-gray-600 leading-relaxed line-clamp-3">
                {post.firecrawlData.summary}
              </p>
            </CardContent>

            <CardFooter>
              <Button
                href={post.url}
                variant="ghost"
                size="sm"
                class="group"
                target="_blank"
                rel="noopener noreferrer"
              >
                Read more
                <svg
                  class="ml-2 h-4 w-4 transition-transform group-hover:translate-x-1"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </Button>
            </CardFooter>
          </Card>
        ))}
      </main>
    </div>
  </div>
</Layout>
