---
import Layout from '../layouts/Layout.astro';
import { db, posts } from '../lib/db';
import { desc } from 'drizzle-orm';
import Badge from '@/components/starwind/badge/Badge.astro';

// Query posts at build time, ordered by publishedAt descending
const allPosts = await db
  .select({
    id: posts.id,
    title: posts.title,
    company: posts.company,
    url: posts.url,
    publishedAt: posts.publishedAt,
    firecrawlData: posts.firecrawlData,
  })
  .from(posts)
  .orderBy(desc(posts.publishedAt));

// Helper to format date in Korean locale
const formatDate = (timestamp: Date | null) => {
  if (!timestamp) return null;
  return new Intl.DateTimeFormat('ko-KR', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  }).format(timestamp);
};

// Map companies to Badge variants (subtle ghost style)
const companyBadgeVariants: Record<string, 'primary' | 'success' | 'warning' | 'info'> = {
  toss: 'primary',
  coupang: 'success',
  daangn: 'warning',
  kakao: 'warning',
  naver: 'success',
  line: 'info',
  woowahan: 'info',
};

// Map companies to left border colors
const companyBorderColors: Record<string, string> = {
  toss: 'border-l-blue-500',
  coupang: 'border-l-rose-500',
  daangn: 'border-l-orange-400',
  kakao: 'border-l-yellow-400',
  naver: 'border-l-green-500',
  line: 'border-l-emerald-400',
  woowahan: 'border-l-cyan-500',
};
---

<Layout>
  <div class="min-h-screen bg-slate-50 py-10">
    <div class="mx-auto max-w-2xl px-4">
      <!-- Header -->
      <header class="mb-8 text-center">
        <h1 class="text-3xl font-bold tracking-tight sm:text-4xl">
          <span class="bg-gradient-to-r from-teal-500 to-cyan-400 bg-clip-text text-transparent">
            postby.io
          </span>
        </h1>
        <p class="mt-2 text-sm text-slate-500">
          Curated engineering blog posts from Korea's top tech companies
        </p>
      </header>

      <!-- Feed -->
      <main class="space-y-3">
        {allPosts.map((post) => (
          <article
            class:list={[
              "group rounded-lg border-l-4 bg-white p-4 shadow-sm",
              "transition-all duration-200 ease-out",
              "hover:shadow-lg hover:-translate-y-0.5 hover:scale-[1.01]",
              "hover:border-l-[6px]",
              companyBorderColors[post.company] || 'border-l-slate-300'
            ]}
          >
            <!-- Meta row -->
            <div class="mb-2 flex items-center gap-2">
              <Badge
                variant={companyBadgeVariants[post.company] || 'default'}
                size="sm"
                class="uppercase text-[10px] tracking-wide"
              >
                {post.company}
              </Badge>
              {post.publishedAt && (
                <time class="text-xs text-slate-400" datetime={post.publishedAt.toISOString()}>
                  {formatDate(post.publishedAt)}
                </time>
              )}
            </div>

            <!-- Title -->
            <h2 class="mb-1.5 text-base font-semibold leading-snug text-slate-800">
              <a
                href={post.url}
                target="_blank"
                rel="noopener noreferrer"
                class="hover:text-teal-600 transition-colors"
              >
                {post.title}
              </a>
            </h2>

            <!-- Summary -->
            <p class="text-sm leading-relaxed text-slate-500 line-clamp-2">
              {post.firecrawlData.summary}
            </p>
          </article>
        ))}
      </main>
    </div>
  </div>
</Layout>
